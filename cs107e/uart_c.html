<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.61">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>uart.c 的代码</title><meta name="description" content="看一遍uart.c的代码">
    <link rel="preload" href="/assets/style-5ca28362.css" as="style"><link rel="stylesheet" href="/assets/style-5ca28362.css">
    <link rel="modulepreload" href="/assets/app-4ee05d6f.js"><link rel="modulepreload" href="/assets/framework-5866ffd3.js"><link rel="modulepreload" href="/assets/uart_c.html-5cde96fe.js"><link rel="modulepreload" href="/assets/uart_c.html-694445c6.js"><link rel="prefetch" href="/assets/index.html-c4c1d27a.js" as="script"><link rel="prefetch" href="/assets/1st-week.html-fe68f33f.js" as="script"><link rel="prefetch" href="/assets/cs107e-risc-v.html-9057ed1f.js" as="script"><link rel="prefetch" href="/assets/index.html-1720408f.js" as="script"><link rel="prefetch" href="/assets/lab1.html-a12869c0.js" as="script"><link rel="prefetch" href="/assets/mangopi.html-7cee1c11.js" as="script"><link rel="prefetch" href="/assets/static-assert.html-40271eda.js" as="script"><link rel="prefetch" href="/assets/helloVuePress.html-7582c42c.js" as="script"><link rel="prefetch" href="/assets/index.html-74580d32.js" as="script"><link rel="prefetch" href="/assets/podman-compose.html-1a3c442f.js" as="script"><link rel="prefetch" href="/assets/reactiveArrayByObjectInVue3.html-7ba34a2a.js" as="script"><link rel="prefetch" href="/assets/reinstallArchlinux.html-1f4babca.js" as="script"><link rel="prefetch" href="/assets/spring-boot-parent.html-68d421db.js" as="script"><link rel="prefetch" href="/assets/404.html-f9875e7b.js" as="script"><link rel="prefetch" href="/assets/index.html-ac945222.js" as="script"><link rel="prefetch" href="/assets/1st-week.html-fb315f42.js" as="script"><link rel="prefetch" href="/assets/cs107e-risc-v.html-9d0b5c65.js" as="script"><link rel="prefetch" href="/assets/index.html-521e993d.js" as="script"><link rel="prefetch" href="/assets/lab1.html-25dff2cb.js" as="script"><link rel="prefetch" href="/assets/mangopi.html-ef0382da.js" as="script"><link rel="prefetch" href="/assets/static-assert.html-c06b832d.js" as="script"><link rel="prefetch" href="/assets/helloVuePress.html-6192dc8e.js" as="script"><link rel="prefetch" href="/assets/index.html-0bdf0b2a.js" as="script"><link rel="prefetch" href="/assets/podman-compose.html-b49c5fc9.js" as="script"><link rel="prefetch" href="/assets/reactiveArrayByObjectInVue3.html-d11ac275.js" as="script"><link rel="prefetch" href="/assets/reinstallArchlinux.html-0138f7f9.js" as="script"><link rel="prefetch" href="/assets/spring-boot-parent.html-03bde350.js" as="script"><link rel="prefetch" href="/assets/404.html-87d54bd8.js" as="script"><link rel="prefetch" href="/assets/giscus-9b97f17f.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container no-sidebar"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><!--v-if--></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/til" class="" aria-label="TodayILearn"><!--[--><!--]--> TodayILearn <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/til" class="" aria-label="TodayILearn"><!--[--><!--]--> TodayILearn <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><!----><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="接着-static-assert看一遍uart-c的代码-未完成" tabindex="-1"><a class="header-anchor" href="#接着-static-assert看一遍uart-c的代码-未完成" aria-hidden="true">#</a> 接着<a href="/cs107e/static-assert.html" class="">_Static_assert</a>看一遍uart.c的代码（未完成）</h1><h2 id="module" tabindex="-1"><a class="header-anchor" href="#module" aria-hidden="true">#</a> module</h2><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> index<span class="token punctuation">;</span>
    <span class="token class-name">gpio_id_t</span> tx<span class="token punctuation">,</span> rx<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> fn<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">uart_config_t</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">uart_t</span> <span class="token operator">*</span>uart_base<span class="token punctuation">,</span> <span class="token operator">*</span>uart<span class="token punctuation">;</span>
    <span class="token class-name">uart_config_t</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span> module <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>uart_base <span class="token operator">=</span> UART_BASE<span class="token punctuation">,</span>
             <span class="token punctuation">.</span>uart <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// will be set in uart_init</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>定义了一个全局变量 <code>module</code></li><li><code>volatile</code> 告诉程序在用这个变量的时候总是从对应地址中读取，而不使用缓存。常用在驱动代码中。</li></ul><h2 id="uart-reinit-custom" tabindex="-1"><a class="header-anchor" href="#uart-reinit-custom" aria-hidden="true">#</a> uart_reinit_custom</h2><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">uart_reinit_custom</span><span class="token punctuation">(</span><span class="token keyword">int</span> uart_id<span class="token punctuation">,</span> <span class="token class-name">gpio_id_t</span> tx<span class="token punctuation">,</span> <span class="token class-name">gpio_id_t</span> rx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> gpio_fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// 设置使用哪个UART，指定GPIO端口，</span>
    module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>index <span class="token operator">=</span> uart_id<span class="token punctuation">;</span>
    module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>tx <span class="token operator">=</span> tx<span class="token punctuation">;</span>
    module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>rx <span class="token operator">=</span> rx<span class="token punctuation">;</span>
    module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>fn <span class="token operator">=</span> gpio_fn<span class="token punctuation">;</span> <span class="token comment">// ？？</span>
    module<span class="token punctuation">.</span>uart <span class="token operator">=</span> module<span class="token punctuation">.</span>uart_base <span class="token operator">+</span> module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>index<span class="token punctuation">;</span>

    <span class="token comment">// clock up peripheral</span>
    <span class="token comment">// gating bits [0:5], reset bits [16:21]</span>
    <span class="token comment">// `CCU_UART_BGR_REG` 地址 `0x090C`</span>
    <span class="token comment">// `0x90C` 寄存器 0-5位代表控制 UART0-5 的时钟控制，置1为打开时钟</span>
    <span class="token comment">// `0x90C` 寄存器 16-21 位代表控制 UART0-5 的复位，置1为解除reset状态</span>
    <span class="token class-name">uint32_t</span> bit <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> reset <span class="token operator">=</span> bit <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
    <span class="token function">ccu_enable_bus_clk</span><span class="token punctuation">(</span>CCU_UART_BGR_REG<span class="token punctuation">,</span> bit<span class="token punctuation">,</span> reset<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// configure GPIOs</span>
    <span class="token comment">// 使能两个GPIO口，TODO 不理解为什么要pullup，为什么要用 GPIO_FN_ALT6</span>
    <span class="token function">gpio_set_function</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>tx<span class="token punctuation">,</span> module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_set_pullup</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_set_function</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>rx<span class="token punctuation">,</span> module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_set_pullup</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>rx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// configure baud rate</span>
    <span class="token class-name">uint32_t</span> baud <span class="token operator">=</span> <span class="token number">115200</span><span class="token punctuation">;</span>
    module<span class="token punctuation">.</span>uart<span class="token operator">-&gt;</span>regs<span class="token punctuation">.</span>fcr <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>      <span class="token comment">// enable TX/RX fifo，UART FIFO Control Register</span>
    module<span class="token punctuation">.</span>uart<span class="token operator">-&gt;</span>regs<span class="token punctuation">.</span>halt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// temporarily disable TX transfer，UART Halt TX Register</span>

    <span class="token class-name">uint32_t</span> sys_clock_rate <span class="token operator">=</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> udiv <span class="token operator">=</span> sys_clock_rate <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">*</span> baud<span class="token punctuation">)</span><span class="token punctuation">;</span>
    module<span class="token punctuation">.</span>uart<span class="token operator">-&gt;</span>regs<span class="token punctuation">.</span>lcr <span class="token operator">|=</span> LCR_DLAB<span class="token punctuation">;</span>  <span class="token comment">// set DLAB = 1 to access DLL/DLH, UART Line Control Register</span>
    module<span class="token punctuation">.</span>uart<span class="token operator">-&gt;</span>regs<span class="token punctuation">.</span>dll <span class="token operator">=</span> udiv <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>        <span class="token comment">// low byte of divisor -&gt; DLL, UART Divisor Latch Low Register</span>
    module<span class="token punctuation">.</span>uart<span class="token operator">-&gt;</span>regs<span class="token punctuation">.</span>dlh <span class="token operator">=</span> <span class="token punctuation">(</span>udiv <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span> <span class="token comment">// hi byte of divisor -&gt; DLH, UART Divisor Latch High Register</span>
    module<span class="token punctuation">.</span>uart<span class="token operator">-&gt;</span>regs<span class="token punctuation">.</span>lcr <span class="token operator">&amp;=</span> <span class="token operator">~</span>LCR_DLAB<span class="token punctuation">;</span> <span class="token comment">// set DLAB = 0 to access RBR/THR</span>
    module<span class="token punctuation">.</span>uart<span class="token operator">-&gt;</span>regs<span class="token punctuation">.</span>halt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">// re-enable TX transfer</span>

    <span class="token comment">// configure data-parity-stop (low 4 bits of LCR)</span>
    <span class="token class-name">uint8_t</span> data <span class="token operator">=</span> <span class="token number">0</span>b11<span class="token punctuation">;</span>    <span class="token comment">// 8 data</span>
    <span class="token class-name">uint8_t</span> parity <span class="token operator">=</span> <span class="token number">0</span>b0<span class="token punctuation">;</span>   <span class="token comment">// no parity</span>
    <span class="token class-name">uint8_t</span> stop <span class="token operator">=</span> <span class="token number">0</span>b0<span class="token punctuation">;</span>     <span class="token comment">// 1 stop</span>
    <span class="token class-name">uint8_t</span> settings <span class="token operator">=</span> <span class="token punctuation">(</span>parity <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>stop <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>data <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>uart<span class="token operator">-&gt;</span>regs<span class="token punctuation">.</span>usr <span class="token operator">&amp;</span> USR_BUSY<span class="token punctuation">)</span> <span class="token punctuation">;</span> <span class="token comment">// wait until uart not busy</span>
    <span class="token comment">// clear low 4 bits, replace with settings 8-n-1</span>
    module<span class="token punctuation">.</span>uart<span class="token operator">-&gt;</span>regs<span class="token punctuation">.</span>lcr <span class="token operator">=</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>uart<span class="token operator">-&gt;</span>regs<span class="token punctuation">.</span>lcr <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0</span>b1111<span class="token punctuation">)</span> <span class="token operator">|</span> settings<span class="token punctuation">;</span>

    module<span class="token punctuation">.</span>uart<span class="token operator">-&gt;</span>regs<span class="token punctuation">.</span>mcr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// disable modem control</span>
    module<span class="token punctuation">.</span>uart<span class="token operator">-&gt;</span>regs<span class="token punctuation">.</span>ier <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// disable interrupts by default</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="confirm-uart-initalized" tabindex="-1"><a class="header-anchor" href="#confirm-uart-initalized" aria-hidden="true">#</a> confirm_uart_initalized</h2><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">confirm_uart_initialized</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fn_name<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 函数的参数是`函数名`</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>uart <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> fn_name <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果全局变量`module.uart`不为空，且参数函数名为空，则抛出错误</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;uart_init() must be called only once&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>uart <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> fn_name <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果全局变量`module.uart`为空，且参数函数不为空，代表还没有调用`uart_init`</span>
        <span class="token comment">// if uart_init has not been called, there is no serial connection to read/write</span>
        <span class="token comment">// All calls to uart operations are dead ends (that means no printf/assert!)</span>
        <span class="token comment">// Force a call to uart_init here to enable reporting of problem</span>
        <span class="token comment">// (otherwise lack of output is ultra mysterious)</span>
        <span class="token function">uart_reinit_custom</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> GPIO_PB8<span class="token punctuation">,</span> GPIO_PB9<span class="token punctuation">,</span> GPIO_FN_ALT6<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;uart_init() must be called before using %s()&quot;</span><span class="token punctuation">,</span> fn_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="uart-reinit-custom-1" tabindex="-1"><a class="header-anchor" href="#uart-reinit-custom-1" aria-hidden="true">#</a> uart_reinit_custom</h2><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">uart_reinit_custom</span><span class="token punctuation">(</span><span class="token keyword">int</span> uart_id<span class="token punctuation">,</span> <span class="token class-name">gpio_id_t</span> tx<span class="token punctuation">,</span> <span class="token class-name">gpio_id_t</span> rx<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> gpio_fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>uart<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// shut down previous if active</span>
        <span class="token function">uart_flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_set_function</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>tx<span class="token punctuation">,</span> GPIO_FN_DISABLED<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// disconnect gpio</span>
        <span class="token function">gpio_set_pullnone</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_set_function</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>rx<span class="token punctuation">,</span> GPIO_FN_DISABLED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">gpio_set_pullnone</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>config<span class="token punctuation">.</span>rx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        module<span class="token punctuation">.</span>uart <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>如果激活过uart，做以下操作把它关闭掉</li><li><code>uart_flush()</code>:</li></ul></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: jiyilc.sd@chinatelecom.cn">Jiyi</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--[--><div class="giscus-wrapper input-top" id="comment" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app-4ee05d6f.js" defer></script>
  </body>
</html>
