<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.61">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>CS107E 第一周</title><meta name="description" content="CS107E 第一周都做了什么">
    <link rel="preload" href="/assets/style-5ca28362.css" as="style"><link rel="stylesheet" href="/assets/style-5ca28362.css">
    <link rel="modulepreload" href="/assets/app-4ee05d6f.js"><link rel="modulepreload" href="/assets/framework-5866ffd3.js"><link rel="modulepreload" href="/assets/1st-week.html-fb315f42.js"><link rel="modulepreload" href="/assets/1st-week.html-fe68f33f.js"><link rel="prefetch" href="/assets/index.html-c4c1d27a.js" as="script"><link rel="prefetch" href="/assets/cs107e-risc-v.html-9057ed1f.js" as="script"><link rel="prefetch" href="/assets/index.html-1720408f.js" as="script"><link rel="prefetch" href="/assets/lab1.html-a12869c0.js" as="script"><link rel="prefetch" href="/assets/mangopi.html-7cee1c11.js" as="script"><link rel="prefetch" href="/assets/static-assert.html-40271eda.js" as="script"><link rel="prefetch" href="/assets/uart_c.html-694445c6.js" as="script"><link rel="prefetch" href="/assets/helloVuePress.html-7582c42c.js" as="script"><link rel="prefetch" href="/assets/index.html-74580d32.js" as="script"><link rel="prefetch" href="/assets/podman-compose.html-1a3c442f.js" as="script"><link rel="prefetch" href="/assets/reactiveArrayByObjectInVue3.html-7ba34a2a.js" as="script"><link rel="prefetch" href="/assets/reinstallArchlinux.html-1f4babca.js" as="script"><link rel="prefetch" href="/assets/spring-boot-parent.html-68d421db.js" as="script"><link rel="prefetch" href="/assets/404.html-f9875e7b.js" as="script"><link rel="prefetch" href="/assets/index.html-ac945222.js" as="script"><link rel="prefetch" href="/assets/cs107e-risc-v.html-9d0b5c65.js" as="script"><link rel="prefetch" href="/assets/index.html-521e993d.js" as="script"><link rel="prefetch" href="/assets/lab1.html-25dff2cb.js" as="script"><link rel="prefetch" href="/assets/mangopi.html-ef0382da.js" as="script"><link rel="prefetch" href="/assets/static-assert.html-c06b832d.js" as="script"><link rel="prefetch" href="/assets/uart_c.html-5cde96fe.js" as="script"><link rel="prefetch" href="/assets/helloVuePress.html-6192dc8e.js" as="script"><link rel="prefetch" href="/assets/index.html-0bdf0b2a.js" as="script"><link rel="prefetch" href="/assets/podman-compose.html-b49c5fc9.js" as="script"><link rel="prefetch" href="/assets/reactiveArrayByObjectInVue3.html-d11ac275.js" as="script"><link rel="prefetch" href="/assets/reinstallArchlinux.html-0138f7f9.js" as="script"><link rel="prefetch" href="/assets/spring-boot-parent.html-03bde350.js" as="script"><link rel="prefetch" href="/assets/404.html-87d54bd8.js" as="script"><link rel="prefetch" href="/assets/giscus-9b97f17f.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container no-sidebar"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><!--v-if--></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/til" class="" aria-label="TodayILearn"><!--[--><!--]--> TodayILearn <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/til" class="" aria-label="TodayILearn"><!--[--><!--]--> TodayILearn <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><!----><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="cs107e-第一周" tabindex="-1"><a class="header-anchor" href="#cs107e-第一周" aria-hidden="true">#</a> CS107E 第一周</h1><h2 id="装东西" tabindex="-1"><a class="header-anchor" href="#装东西" aria-hidden="true">#</a> 装东西</h2><p>给的指导教程里面，macos arm版的支持度比其他要好一点，主要体现在一开始没有intel版的编译工具（现在有了），wsl版的编译工具编译<code>sample_build</code>代码不成功（现在可以了），wsl版没有<code>riscv64-unknown-elf-gdb</code>（文档更新暂时不需要gdb了）。毕竟这个课第一次用riscv教学。</p><p><s>基于个人习惯，用虚拟机装ubuntu搞实验环境</s></p><ul><li><s>虚拟机安装 Ubuntu 22.04 server</s></li><li><s><a href="https://cs107e.github.io/guides/install/devtools-wsl/" target="_blank" rel="noopener noreferrer">安装编译环境<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></s><ul><li><s>只看 <code>Install riscv-unknown-elf toolchain</code>部分</s></li></ul></li><li><s><a href="https://xboot.org/xfel/#/" target="_blank" rel="noopener noreferrer">安装xfel<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></s><ul><li><s>编译安装xfel到Ubuntu中</s></li></ul></li></ul><blockquote><p>发现教程里面的riscv安装包用的是Debian 12.2 的，那我直接虚拟机安装 Debian 就好了嘛</p></blockquote><h3 id="搭建-debian-12-2-虚拟机实验环境" tabindex="-1"><a class="header-anchor" href="#搭建-debian-12-2-虚拟机实验环境" aria-hidden="true">#</a> 搭建 Debian 12.2 虚拟机实验环境</h3><ol><li>下载<a href="https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-12.4.0-amd64-netinst.iso" target="_blank" rel="noopener noreferrer">镜像<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>安装Debian，安装 <code>SSH server</code> 和 <code>standard system utilties</code>，不安装桌面</li><li>进入系统安装必要包<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">apt</span> <span class="token function">install</span> <span class="token function">sudo</span> <span class="token function">vim</span> <span class="token function">git</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li>安装虚拟机工具，顺便安装了gcc, make, linux-header等东西</li><li>用户加入到sudo组里面<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">usermod</span> <span class="token parameter variable">-a</span> <span class="token parameter variable">-G</span> <span class="token function">sudo</span> jiyi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li>安装交叉编译工具<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> gcc-riscv64-unknown-elf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><a href="https://xboot.org/xfel/#/" target="_blank" rel="noopener noreferrer">安装xfel<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/xboot/xfel.git
<span class="token builtin class-name">cd</span> xfel
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libusb-1.0-0-dev pkg-config
<span class="token function">make</span>
<span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span>
<span class="token comment"># 使用以下命令就能检测到插上OTG口芒果派</span>
xfel version
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>cs107e环境<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> ~/cs107e_home
<span class="token builtin class-name">cd</span> ~/cs107e_home
<span class="token function">git</span> clone https://github.com/cs107e/cs107e.github.io.git
<span class="token function">vim</span> ~/.bashrc
<span class="token comment"># 添加以下两行</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CS107E</span><span class="token operator">=~</span>/cs107e_home/cs107e.github.io/cs107e
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$CS107E</span>/bin

<span class="token builtin class-name">source</span> ~/.bashrc
<span class="token builtin class-name">cd</span> <span class="token variable">$CS107E</span>/sample_build
<span class="token function">make</span>
<span class="token comment"># 没报错就是第6步安装正常</span>

<span class="token builtin class-name">cd</span> <span class="token variable">$CS107E</span>/bin
mango-run blink-actled.bin
<span class="token comment"># 芒果派led开始闪，说明第7步安装正常</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h2 id="学东西" tabindex="-1"><a class="header-anchor" href="#学东西" aria-hidden="true">#</a> 学东西</h2><p>第一周是汇编和riscv，官方讲义过于简略了。去B站看<a href="https://www.bilibili.com/video/BV1Q5411w7z5" target="_blank" rel="noopener noreferrer">循序渐进，学习开发一个RISC-V上的操作系统 - 汪辰 - 2021春<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="risc-的5级流水线" tabindex="-1"><a class="header-anchor" href="#risc-的5级流水线" aria-hidden="true">#</a> RISC 的5级流水线</h3><p>为了看懂<a href="https://ripes.me/" target="_blank" rel="noopener noreferrer">ripes.me<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>的Stage。来源 https://www.sunnychen.top/archives/rvintropipeline https://en.wikipedia.org/wiki/Classic_RISC_pipeline</p><ul><li>IF = Instruction Fetch <ul><li>从指令存储器中获取指令</li></ul></li><li>ID = Instruction Decode <ul><li>译码并读取寄存器</li></ul></li><li>EX = Execute <ul><li>执行指令</li></ul></li><li>MEM = Memory access <ul><li>从数据存储器中读取数据</li></ul></li><li>WB = Register write back <ul><li>将结果写回寄存器</li></ul></li></ul><h3 id="_1gb的内存大小是0x40000000" tabindex="-1"><a class="header-anchor" href="#_1gb的内存大小是0x40000000" aria-hidden="true">#</a> 1GB的内存大小是0x40000000</h3><p>一位16进制代表4位二进制，0x40000000 是1后面跟<code>4*7+2=30</code>个0的二进制数，即2<sup>30</sup>个地址。</p><p>1个地址代表1byte=1B=8bit的数据。</p><p>2<sup>10</sup> 是 0x00000400 是 1KB<br> 2<sup>20</sup> 是 0x00100000 是 1MB 是 1K个1KB<br> 2<sup>30</sup> 是 0x40000000 是 1GB 是 1K个1MB</p><p>严格来说以上地址都应该<strong>减1</strong>，即1GB的内存大小是0x40000000-1</p><h3 id="指令存储" tabindex="-1"><a class="header-anchor" href="#指令存储" aria-hidden="true">#</a> 指令存储</h3><p><code>add x3, x1, x2</code> 将寄存器 x1 + x2 结果放入 x3 中</p><p><img src="/assets/image-20240113110521079-0bc4e424.png" alt="image-20240113110521079"></p><p>以上指令长32bit，为<code>0x0020 81B3</code></p><p>每个内存地址存储8bit，小端存储，则以上指令在内存中的顺序是 B3, 81, 20, 00</p><h3 id="点亮led" tabindex="-1"><a class="header-anchor" href="#点亮led" aria-hidden="true">#</a> 点亮LED</h3><ul><li>led内里大头是负极</li><li>MMIO(Memory mapping I/O)就是<strong>通过将外围设备映射到内存空间，便于CPU的访问</strong></li><li>GPIO地址从<code>0x0200 0000</code>开始</li><li>内存(DRAM)地址从<code>0x4000 0000</code> 开始，<code>0xBFFF FFFF</code> 结束，共2G可用地址</li><li>用了两个寄存器 <code>PB_CFG0</code> 和 <code>PB_CFG1</code> 共52bit，设置13个PB接口 PB0 到 PB12</li><li>每个GPIO，fn0(0000)是输入，fn1(0001)是输出，fn9-13保留，其他位看文档</li><li>用了一个寄存器 <code>PB_DAT</code> 共 13bit，用于13个PB口的读写或拉高降低</li><li>当CFG设置为输出(1)，DAT设1是高电平，0是低电平</li><li>MangoPi 默认启用<code>FEL</code>模式(Firmware Exchange Loader)（固件更换器？），用xfel 进行控制</li><li><code>lui</code> 高位立即数装载指令，把立即数左移12位，存入寄存器中 <ul><li>0x2000 &lt;&lt; 12 == <code>0x0200 0000</code> （左移 3个4bit，16进制加3个0）</li></ul></li><li><code>sw</code> 字存储指令，把寄存器加上偏移量的地址，用目标寄存器中的值进行设置</li><li>有伪指令 <code>li rd, immediate</code> 立即数加载指令可替代 <code>addi a1, zero, 1</code><ul><li>hexdump后为<code>93 05 10 00</code>，即指令<code>0x00100593</code></li><li>二进制为 <code>0b0000 0000 0001 0000 0000 0101 1001 0011</code></li><li>以指令分割 <code>000000000001 00000 000 01011 0010011</code></li><li>得到汇编指令 <code>addi x11,x0,1</code></li><li>即 <code>addi a1, zero, 1</code></li><li>结论：立即数不大的时候<code>li</code>使用的就是<code>addi</code>指令</li></ul></li><li>命令行<code>riscv64-unknown-elf-as on.s -o on.o</code><ul><li>将指定汇编文件 <code>on.s</code> 编译成指定名称 <code>on.o</code></li><li><code>-o</code> 指定输出的文件名</li></ul></li><li>命令行 <code>riscv64-unknown-elf-objcopy on.o -O binary on.bin</code><ul><li><code>-O binary</code> 输出为原始的二进制文件</li><li>使用xfel运行程序，原始二进制就够了</li></ul></li></ul></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: jiyilc.sd@chinatelecom.cn">Jiyi</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--[--><div class="giscus-wrapper input-top" id="comment" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app-4ee05d6f.js" defer></script>
  </body>
</html>
